<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencias</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCeu2TJ6jRHfLTlWG84TJ1GQma6MoRcuA0",
            authDomain: "sistema-asistencias-9eacf.firebaseapp.com",
            projectId: "sistema-asistencias-9eacf",
            storageBucket: "sistema-asistencias-9eacf.firebasestorage.app",
            messagingSenderId: "663369371857",
            appId: "1:663369371857:web:c263e4922b8810a52735f0"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Hacer disponible globalmente
        window.db = db;
        window.firestore = { collection, doc, setDoc, getDoc, getDocs, deleteDoc };
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 10px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .quincena-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .quincena-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quincena-btn.active {
            background: white;
            color: #2563eb;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: white;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #2563eb;
            color: white;
        }

        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .empleado-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .empleado-form input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .search-box:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:active {
            background: #1d4ed8;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .empleados-list {
            list-style: none;
        }

        .empleado-item {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .empleado-item:last-child {
            border-bottom: none;
        }

        .empleado-nombre {
            font-weight: 500;
        }

        .asistencia-select {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .asistencia-select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .asistencia-select.registrado {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .asistencia-grid {
            overflow-x: auto;
        }

        .asistencia-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .asistencia-table th {
            background: #f3f4f6;
            padding: 12px 8px;
            text-align: left;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .asistencia-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #2563eb;
        }

        .resumen-grid {
            margin-top: 20px;
            display: grid;
            gap: 12px;
        }

        .resumen-item {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .resumen-item.expanded {
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
            border-color: #2563eb;
        }

        .resumen-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .resumen-header:hover {
            background: #f9fafb;
        }

        .resumen-header:active {
            background: #f3f4f6;
        }

        .resumen-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .resumen-nombre {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            flex-grow: 1;
        }

        .resumen-expand-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            transition: transform 0.3s;
            font-size: 20px;
        }

        .resumen-item.expanded .resumen-expand-icon {
            transform: rotate(180deg);
        }

        .resumen-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .resumen-item.expanded .resumen-content {
            max-height: 300px;
        }

        .resumen-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 0 20px 20px 20px;
        }

        .resumen-stat-box {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s;
        }

        .resumen-stat-box:hover {
            background: #f3f4f6;
        }

        .resumen-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .resumen-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
        }

        .resumen-stat-box.dias .resumen-stat-value {
            color: #2563eb;
        }

        .resumen-stat-box.extras .resumen-stat-value {
            color: #f59e0b;
        }

        .resumen-stat-box.total {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
        }

        .resumen-stat-box.total .resumen-stat-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .resumen-stat-box.total .resumen-stat-value {
            color: white;
        }

        .actions-section {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .actions-section h3 {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .actions-buttons {
            display: grid;
            gap: 10px;
        }

        @media (max-width: 600px) {
            .resumen-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .resumen-stat-box {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: left;
            }

            .resumen-stat-label {
                margin-bottom: 0;
            }
        }        

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        @media (max-width: 600px) {
            .empleado-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .resumen-item {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .resumen-item .label-mobile {
                display: inline;
                font-weight: 600;
                margin-right: 5px;
            }
        }

        .label-mobile {
            display: none;
        }

        .current-date {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .quick-marks {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-mark-btn {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-mark-btn:active {
            background: #f3f4f6;
        }

        .info-text {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .dia-actual-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Indicador de carga -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p style="color: #6b7280; font-size: 16px;">Cargando datos...</p>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìã Sistema de Asistencias</h1>
            <div class="current-date" id="currentDate"></div>
            <div class="quincena-selector">
                <button class="quincena-btn active" onclick="cambiarQuincena(1)">Primera Quincena</button>
                <button class="quincena-btn" onclick="cambiarQuincena(2)">Segunda Quincena</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="cambiarTab('empleados')">üë• Registro Hoy</button>
            <button class="tab-btn" onclick="cambiarTab('asistencias')">üìÖ Historial</button>
            <button class="tab-btn" onclick="cambiarTab('resumen')">üìä Resumen</button>
        </div>

        <!-- Secci√≥n Empleados -->
        <div id="empleados-section" class="section active">
            <h2 style="margin-bottom: 15px;">Registro del D√≠a</h2>
            <div class="dia-actual-badge" id="diaActualBadge"></div>

            <input type="text" class="search-box" id="searchBox" placeholder="üîç Buscar empleado..." onkeyup="filtrarEmpleados()" />

            <div class="empleado-form">
                <input type="text" id="nombreEmpleado" placeholder="Nombre del empleado" />
                <button class="btn btn-primary" onclick="agregarEmpleado()">+ Agregar</button>
            </div>

            <ul class="empleados-list" id="empleadosList"></ul>
        </div>

        <!-- Secci√≥n Asistencias -->
        <div id="asistencias-section" class="section">
            <h2 style="margin-bottom: 15px;">Historial de Asistencias</h2>
            
            <div class="info-text">
                <strong>Editar registros:</strong> Selecciona una marca diferente para modificar el registro de cualquier d√≠a.
            </div>

            <input type="text" class="search-box" id="searchBoxHistorial" placeholder="üîç Buscar empleado..." onkeyup="renderAsistencias()" />

            <div class="asistencia-grid">
                <table class="asistencia-table" id="asistenciasTable"></table>
            </div>
        </div>

        <!-- Secci√≥n Resumen -->
        <div id="resumen-section" class="section">
            <h2 style="margin-bottom: 20px;">Resumen de Quincena</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="label">Total Empleados</div>
                    <div class="value" id="totalEmpleados">0</div>
                </div>                
            </div>

            <!-- Botones de acciones arriba -->
            <div class="actions-section">
                <h3>Acciones</h3>
                <div class="actions-buttons">
                    <button class="btn btn-success" onclick="exportarExcel()" style="width: 100%;">
                        üì• Exportar a Excel
                    </button>
                    <button class="btn" onclick="moverDiasAlSiguienteMes()" style="width: 100%; background: #3b82f6; color: white;">
                        üìÖ Mover D√≠as al Siguiente Mes
                    </button>
                    <button class="btn btn-danger" onclick="limpiarMesAnterior()" style="width: 100%; background: #f59e0b;">
                        üóëÔ∏è Limpiar Registros del Mes Anterior
                    </button>
                </div>
            </div>

            <input type="text" class="search-box" id="searchBoxResumen" placeholder="üîç Buscar empleado..." onkeyup="renderResumen()" />

            <!-- Lista de empleados colapsable -->
            <div class="resumen-grid" id="resumenGrid"></div>
        </div>
    </div>

    <script>
        let empleados = [
            { id: 1, nombre: "Acosta Sandra" },
            { id: 2, nombre: "Aguiar Doris" },
            { id: 3, nombre: "Alegre Raul" },
            { id: 4, nombre: "Almada Carolina" },
            { id: 5, nombre: "Almeida Ricardo" },
            { id: 6, nombre: "Altamirano Ignacio" },
            { id: 7, nombre: "Altamirano Marcelo" },
            { id: 8, nombre: "Alvarenga Vivian" },
            { id: 9, nombre: "Amarilla Marcelino" },
            { id: 10, nombre: "Arguello Lucio" },
            { id: 11, nombre: "Armua Ivan" },
            { id: 12, nombre: "Armua Jose" },
            { id: 13, nombre: "Armua Ramon Eduardo" },
            { id: 14, nombre: "Armua Raul" },
            { id: 15, nombre: "Ayala Betiana" },
            { id: 16, nombre: "Ayala Maria Ines" },
            { id: 17, nombre: "Ayala Ramon" },
            { id: 18, nombre: "Ayala Santiago" },
            { id: 19, nombre: "Barrios Apolonio" },
            { id: 20, nombre: "Barrios Bernabe" },
            { id: 21, nombre: "Barrios Felipe" },
            { id: 22, nombre: "Benitez Alejandro" },
            { id: 23, nombre: "Benitez David Hector" },
            { id: 24, nombre: "Benitez Dip Juan Ramon" },
            { id: 25, nombre: "Benitez Jose" },
            { id: 26, nombre: "Benitez Lucia" },
            { id: 27, nombre: "Benitez Mario" },
            { id: 28, nombre: "Benitez Miguel" },
            { id: 29, nombre: "Britez Gisela" },
            { id: 30, nombre: "Britez Maria Ignacia" },
            { id: 31, nombre: "Burgos Alicia" },
            { id: 32, nombre: "Burgos Hilda" },
            { id: 33, nombre: "Caballero Patricia" },
            { id: 34, nombre: "Cabral Leonardo" },
            { id: 35, nombre: "Cabral Maria C" },
            { id: 36, nombre: "Cabral Olga" },
            { id: 37, nombre: "Centurion Ramon" },
            { id: 38, nombre: "Comisario Josefina" },
            { id: 39, nombre: "Contin Alejandra Soledad" },
            { id: 40, nombre: "Contin Daniel" },
            { id: 41, nombre: "Delgado Andres Roberto" },
            { id: 42, nombre: "Delgado Griselda" },
            { id: 43, nombre: "Diaz Jorge" },
            { id: 44, nombre: "Diaz Ruben" },
            { id: 45, nombre: "Encina Carmen" },
            { id: 46, nombre: "Encina Jose Osvaldo" },
            { id: 47, nombre: "Encina Jose Vicente" },
            { id: 48, nombre: "Encina Mercedes" },
            { id: 49, nombre: "Enrique Maria Soledad" },
            { id: 50, nombre: "Enrique Zunilda" },
            { id: 51, nombre: "Enriquez Aida" },
            { id: 52, nombre: "Enriquez Javier" },
            { id: 53, nombre: "Esquivel Cecilia" },
            { id: 54, nombre: "Esquivel Jorge" },
            { id: 55, nombre: "Esquivel Lazaro" },
            { id: 56, nombre: "Esquivel Norberto" },
            { id: 57, nombre: "Fernandez Adriana" },
            { id: 58, nombre: "Fernandez Berenice" },
            { id: 59, nombre: "Fernandez Graciela" },
            { id: 60, nombre: "Fernandez Ismael" },
            { id: 61, nombre: "Fernandez Osvaldo" },
            { id: 62, nombre: "Fernandez Rosana" },
            { id: 63, nombre: "Fernandez Sandra" },
            { id: 64, nombre: "Figueroa Denisse" },
            { id: 65, nombre: "Figueroa Juliana" },
            { id: 66, nombre: "Flores Miguel Angel" },
            { id: 67, nombre: "Flores Omar" },
            { id: 68, nombre: "Franco Leonardo" },
            { id: 69, nombre: "Frias Gregorio" },
            { id: 70, nombre: "Galarza Omar" },
            { id: 71, nombre: "Gauna Ana Rosa" },
            { id: 72, nombre: "Gauna Andres" },
            { id: 73, nombre: "Gauna Antonia" },
            { id: 74, nombre: "Gauna Marisel" },
            { id: 75, nombre: "Gauna Sabina" },
            { id: 76, nombre: "Gomez Sandra" },
            { id: 77, nombre: "Gonzalez Juan" },
            { id: 78, nombre: "Gonzalez Nelly" },
            { id: 79, nombre: "Gonzalez Ruben" },
            { id: 80, nombre: "Gonzalez Saturnino" },
            { id: 81, nombre: "Hernandez Luis" },
            { id: 82, nombre: "Hidalgo Jorge" },
            { id: 83, nombre: "Hidalgo Marcial" },
            { id: 84, nombre: "Hidalgo Nahuel" },
            { id: 85, nombre: "Irala Marcos" },
            { id: 86, nombre: "Lencina Jose" },
            { id: 87, nombre: "Lotero Ceferina" },
            { id: 88, nombre: "Maciel Nidia" },
            { id: 89, nombre: "Maidana Veronica Itati" },
            { id: 90, nombre: "Martinez Miguel Angel" },
            { id: 91, nombre: "Martinez Silvestre" },
            { id: 92, nombre: "Martres Sandra" },
            { id: 93, nombre: "Mi√±o Mariela" },
            { id: 94, nombre: "Morales Fabiana" },
            { id: 95, nombre: "Morel Saul" },
            { id: 96, nombre: "Mosqueda Hugo" },
            { id: 97, nombre: "Mosqueda Johana" },
            { id: 98, nombre: "Mosqueda Jose" },
            { id: 99, nombre: "Navarro Maria" },
            { id: 100, nombre: "Navarro Walter" },
            { id: 101, nombre: "Ndure Elias" },
            { id: 102, nombre: "Niz Victor Hugo" },
            { id: 103, nombre: "Ojeda Diego" },
            { id: 104, nombre: "Ojeda Facundo" },
            { id: 105, nombre: "Ojeda Leonela" },
            { id: 106, nombre: "Ojeda Mirtha" },
            { id: 107, nombre: "Ojeda Sergio" },
            { id: 108, nombre: "Ortiz Martina" },
            { id: 109, nombre: "Pai Marcelo" },
            { id: 110, nombre: "Pais Marta" },
            { id: 111, nombre: "Palacios Juan Ramon" },
            { id: 112, nombre: "Panczak Hector" },
            { id: 113, nombre: "Peralta Marcelo" },
            { id: 114, nombre: "Peralta Mario" },
            { id: 115, nombre: "Peralta Rafael" },
            { id: 116, nombre: "Perez Luis Miguel" },
            { id: 117, nombre: "Perez Rosa" },
            { id: 118, nombre: "Perez Walter" },
            { id: 119, nombre: "Pica Jesus" },
            { id: 120, nombre: "Portillo Dario" },
            { id: 121, nombre: "Portillo Raul" },
            { id: 122, nombre: "Ramirez Florencia" },
            { id: 123, nombre: "Ramirez Paola" },
            { id: 124, nombre: "Ramirez Raul Ernesto" },
            { id: 125, nombre: "Ramirez Teresa" },
            { id: 126, nombre: "Rigoni Francisco" },
            { id: 127, nombre: "Rios Anastacia" },
            { id: 128, nombre: "Rios Domingo Ramon" },
            { id: 129, nombre: "Rios Noelia" },
            { id: 130, nombre: "Rita Sanchez" },
            { id: 131, nombre: "Rivero Ivan" },
            { id: 132, nombre: "Rodriguez Mariela" },
            { id: 133, nombre: "Rodriguez Monica Isabel" },
            { id: 134, nombre: "Rodriguez Ren√©" },
            { id: 135, nombre: "Rojas Carmelo" },
            { id: 136, nombre: "Romero Eduardo" },
            { id: 137, nombre: "Romero Gregorio" },
            { id: 138, nombre: "Romero Lider" },
            { id: 139, nombre: "Romero Marcela" },
            { id: 140, nombre: "Romero Maria" },
            { id: 141, nombre: "Romero Mario Catalino" },
            { id: 142, nombre: "Romero Porfidio" },
            { id: 143, nombre: "Romero Ricardo" },
            { id: 144, nombre: "Romero Rito" },
            { id: 145, nombre: "Romero Waldino E" },
            { id: 146, nombre: "Rosales Jorge" },
            { id: 147, nombre: "Ruiz Diaz Ramon" },
            { id: 148, nombre: "Sanchez Luis" },
            { id: 149, nombre: "Sanchez Manuel" },
            { id: 150, nombre: "Silva Noelia" },
            { id: 151, nombre: "Sonza Vanira" },
            { id: 152, nombre: "Sosa Orlando" },
            { id: 153, nombre: "Sosa Silvia" },
            { id: 154, nombre: "Torres Ramona" },
            { id: 155, nombre: "Torres Tomas" },
            { id: 156, nombre: "Ubeda Jorge" },
            { id: 157, nombre: "Valenzuela Daniela" },
            { id: 158, nombre: "Vallejos Alicio" },
            { id: 159, nombre: "Vallejos Belen" },
            { id: 160, nombre: "Vallejos Heraldo" },
            { id: 161, nombre: "Vasquez Ramon" },
            { id: 162, nombre: "Vega Antonio" },
            { id: 163, nombre: "Vega Yesica" },
            { id: 164, nombre: "Vera Justo" },
            { id: 165, nombre: "Vera Sosa Marlene" },
            { id: 166, nombre: "Vergara Ester" },
            { id: 167, nombre: "Villalva Andrea" },
            { id: 168, nombre: "Yedro Graciela" },
            { id: 169, nombre: "Yedro Leonardo Antonio" },
            { id: 170, nombre: "Zalazar Ariel Antonio" },
            { id: 171, nombre: "Zalazar Gisela" },
            { id: 172, nombre: "Zalazar Leonardo" },
            { id: 173, nombre: "Ziegenbein Ramon Eduardo" }
        ];
        let asistencias = {};
        let quincenaActual = 1;
        let tabActual = 'empleados';
        let diaActual = 0;

        // Opciones del men√∫ desplegable
        const opcionesAsistencia = [
            { value: '', label: '-- Sin marcar --' },
            { value: 'P', label: 'P - Presente' },
            { value: 'A', label: 'A - Ausente' },
            { value: 'P + 1+', label: 'P + 1+ (Presente + 1 extra)' },
            { value: 'P + 2+', label: 'P + 2+ (Presente + 2 extras)' },
            { value: 'P + 3+', label: 'P + 3+ (Presente + 3 extras)' },
            { value: 'P + 1++', label: 'P + 1++ (Presente + doble)' },
            { value: 'P + 2++', label: 'P + 2++ (Presente + 2 dobles)' },
        ];

        // Inicializar
        async function init() {
            try {
                await cargarDatos();
                calcularDiaActual();
                actualizarFecha();
                renderEmpleados();
                renderAsistencias();
                renderResumen();
                
                // Ocultar loading
                document.getElementById('loadingOverlay').classList.add('hidden');
            } catch (error) {
                console.error('Error al inicializar:', error);
                alert('Error al cargar la aplicaci√≥n. Por favor recarga la p√°gina.');
            }
        }

        function calcularDiaActual() {
            const hoy = new Date();
            diaActual = hoy.getDate();
            
            // Determinar autom√°ticamente la quincena seg√∫n el d√≠a
            if (diaActual <= 15) {
                quincenaActual = 1;
            } else {
                quincenaActual = 2;
            }
            
            // Actualizar botones de quincena
            document.querySelectorAll('.quincena-btn').forEach((btn, idx) => {
                if (idx + 1 === quincenaActual) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function actualizarFecha() {
            const hoy = new Date();
            const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = hoy.toLocaleDateString('es-ES', opciones);
            document.getElementById('diaActualBadge').textContent = `Registrando d√≠a ${diaActual}`;
        }

        async function cargarDatos() {
            try {
                // Cargar empleados
                const empleadosDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'sistema', 'empleados'));
                if (empleadosDoc.exists()) {
                    const listaGuardada = empleadosDoc.data().lista || [];
                    // Si hay empleados guardados, usarlos. Si no, mantener los predefinidos
                    if (listaGuardada.length > 0) {
                        empleados = listaGuardada;
                    } else {
                        // Si Firebase est√° vac√≠o, guardar la lista predefinida
                        await guardarDatos();
                    }
                } else {
                    // Si no existe el documento, guardar la lista predefinida
                    await guardarDatos();
                }

                // Cargar asistencias
                const asistenciasDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'sistema', 'asistencias'));
                if (asistenciasDoc.exists()) {
                    asistencias = asistenciasDoc.data() || {};
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al cargar datos desde la nube. Por favor recarga la p√°gina.');
            }
        }

        async function guardarDatos() {
            try {
                // Guardar empleados
                await window.firestore.setDoc(window.firestore.doc(window.db, 'sistema', 'empleados'), {
                    lista: empleados
                });

                // Guardar asistencias
                await window.firestore.setDoc(window.firestore.doc(window.db, 'sistema', 'asistencias'), asistencias);
            } catch (error) {
                console.error('Error guardando datos:', error);
                alert('Error al guardar datos en la nube. Intenta nuevamente.');
            }
        }

        function cambiarTab(tab) {
            tabActual = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-section`).classList.add('active');

            if (tab === 'empleados') renderEmpleados();
            if (tab === 'asistencias') renderAsistencias();
            if (tab === 'resumen') renderResumen();
        }

        function cambiarQuincena(numero) {
            quincenaActual = numero;
            document.querySelectorAll('.quincena-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            calcularDiaActual(); // Recalcular d√≠a actual
            if (tabActual === 'empleados') renderEmpleados();
            if (tabActual === 'asistencias') renderAsistencias();
            if (tabActual === 'resumen') renderResumen();
        }

        function agregarEmpleado() {
            const nombre = document.getElementById('nombreEmpleado').value.trim();
            if (!nombre) {
                alert('Por favor ingresa un nombre');
                return;
            }

            empleados.push({ id: Date.now(), nombre });
            empleados.sort((a, b) => a.nombre.localeCompare(b.nombre)); // Ordenar alfab√©ticamente
            document.getElementById('nombreEmpleado').value = '';
            guardarDatos();
            renderEmpleados();
        }

        function eliminarEmpleado(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este empleado?')) return;
            
            empleados = empleados.filter(e => e.id !== id);
            delete asistencias[id];
            guardarDatos();
            renderEmpleados();
            renderAsistencias();
        }

        function crearSelectAsistencia(empId, dia) {
            const key = `${empId}-${quincenaActual}-${dia}`;
            const valorActual = asistencias[key] || '';
            
            let select = '<select class="asistencia-select';
            if (valorActual) select += ' registrado';
            select += `" onchange="guardarAsistencia(${empId}, ${dia}, this.value)">`;
            
            opcionesAsistencia.forEach(opcion => {
                const selected = opcion.value === valorActual ? 'selected' : '';
                select += `<option value="${opcion.value}" ${selected}>${opcion.label}</option>`;
            });
            
            select += '</select>';
            return select;
        }

        function renderEmpleados() {
            const lista = document.getElementById('empleadosList');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (empleados.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <p>No hay empleados registrados</p>
                        <p style="font-size: 14px; margin-top: 10px;">Agrega empleados para comenzar</p>
                    </div>
                `;
                return;
            }

            const empleadosFiltrados = empleados.filter(emp => 
                emp.nombre.toLowerCase().includes(searchTerm)
            );

            if (empleadosFiltrados.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No se encontraron empleados</p>
                    </div>
                `;
                return;
            }

            lista.innerHTML = empleadosFiltrados.map(emp => `
                <li class="empleado-item">
                    <div class="empleado-nombre">${emp.nombre}</div>
                    ${crearSelectAsistencia(emp.id, diaActual)}
                    <button class="btn btn-danger" onclick="eliminarEmpleado(${emp.id})">Eliminar</button>
                </li>
            `).join('');
        }

        function filtrarEmpleados() {
            renderEmpleados();
        }

        function getDiasQuincena() {
            const hoy = new Date();
            const mes = hoy.getMonth();
            const anio = hoy.getFullYear();
            
            if (quincenaActual === 1) {
                return Array.from({length: 15}, (_, i) => i + 1);
            } else {
                const ultimoDia = new Date(anio, mes + 1, 0).getDate();
                return Array.from({length: ultimoDia - 15}, (_, i) => i + 16);
            }
        }

        function renderAsistencias() {
            const tabla = document.getElementById('asistenciasTable');
            const dias = getDiasQuincena();
            const searchTerm = document.getElementById('searchBoxHistorial').value.toLowerCase();

            if (empleados.length === 0) {
                tabla.innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px;">
                        <div class="empty-state-icon">üë•</div>
                        <p>Agrega empleados primero en la pesta√±a "Registro Hoy"</p>
                    </td></tr>
                `;
                return;
            }

            const empleadosFiltrados = empleados.filter(emp => 
                emp.nombre.toLowerCase().includes(searchTerm)
            );

            if (empleadosFiltrados.length === 0) {
                tabla.innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px;">
                        <div class="empty-state-icon">üîç</div>
                        <p>No se encontraron empleados</p>
                    </td></tr>
                `;
                return;
            }

            let html = '<thead><tr><th>Empleado</th>';
            dias.forEach(dia => {
                const esHoy = dia === diaActual;
                html += `<th style="${esHoy ? 'background: #dbeafe; font-weight: bold;' : ''}">D√≠a ${dia}${esHoy ? ' ‚úì' : ''}</th>`;
            });
            html += '</tr></thead><tbody>';

            empleadosFiltrados.forEach(emp => {
                html += `<tr><td><strong>${emp.nombre}</strong></td>`;
                dias.forEach(dia => {
                    html += `<td>${crearSelectAsistencia(emp.id, dia)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody>';
            tabla.innerHTML = html;
        }

        function guardarAsistencia(empId, dia, valor) {
            const key = `${empId}-${quincenaActual}-${dia}`;
            asistencias[key] = valor;
            guardarDatos();
            
            // Actualizar visualmente el select
            event.target.className = valor ? 'asistencia-select registrado' : 'asistencia-select';
        }

        function calcularTotales(empId, incluirExtrasDelMes = false) {
            const dias = getDiasQuincena();
            let diasNormales = 0;
            let extras = 0;

            dias.forEach(dia => {
                const key = `${empId}-${quincenaActual}-${dia}`;
                const valor = asistencias[key] || '';

                // Contar d√≠as normales (si contiene P)
                if (valor.includes('P')) {
                    diasNormales++;
                }

                // Contar extras
                if (valor.includes('+')) {
                    // Buscar todos los n√∫meros seguidos de +
                    const matches = valor.match(/(\d+)\+/g);
                    if (matches) {
                        matches.forEach(match => {
                            const num = parseInt(match.match(/\d+/)[0]);
                            // Si tiene ++ es doble
                            if (valor.includes('++')) {
                                extras += num * 2;
                            } else {
                                extras += num;
                            }
                        });
                    }
                }
            });

            // Si estamos en 2da quincena y queremos incluir extras del mes completo
            if (incluirExtrasDelMes && quincenaActual === 2) {
                // Calcular extras de la 1ra quincena tambi√©n
                const diasPrimeraQuincena = Array.from({length: 15}, (_, i) => i + 1);
                diasPrimeraQuincena.forEach(dia => {
                    const key = `${empId}-1-${dia}`;
                    const valor = asistencias[key] || '';

                    if (valor.includes('+')) {
                        const matches = valor.match(/(\d+)\+/g);
                        if (matches) {
                            matches.forEach(match => {
                                const num = parseInt(match.match(/\d+/)[0]);
                                if (valor.includes('++')) {
                                    extras += num * 2;
                                } else {
                                    extras += num;
                                }
                            });
                        }
                    }
                });
            }

            return { diasNormales, extras, total: diasNormales + extras };
        }

        function renderResumen() {
            const grid = document.getElementById('resumenGrid');
            const searchBoxResumen = document.getElementById('searchBoxResumen');
            const filtro = searchBoxResumen ? searchBoxResumen.value.toLowerCase() : '';

            if (empleados.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No hay datos para mostrar</p>
                    </div>
                `;
                return;
            }

            // Filtrar empleados
            const empleadosFiltrados = empleados.filter(emp => 
                emp.nombre.toLowerCase().includes(filtro)
            );

            if (empleadosFiltrados.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No se encontraron empleados</p>
                    </div>
                `;
                document.getElementById('totalEmpleados').textContent = '0';
                return;
            }

            let html = '';

            empleadosFiltrados.forEach(emp => {
                const { diasNormales, extras, total } = calcularTotales(emp.id);
                
                // Obtener iniciales del nombre para el avatar
                const iniciales = emp.nombre
                    .split(' ')
                    .map(n => n[0])
                    .slice(0, 2)
                    .join('')
                    .toUpperCase();

                html += `
                    <div class="resumen-item" id="resumen-${emp.id}">
                        <div class="resumen-header" onclick="toggleResumen(${emp.id})">
                            <div class="resumen-avatar">${iniciales}</div>
                            <div class="resumen-nombre">${emp.nombre}</div>
                            <div class="resumen-expand-icon">‚ñº</div>
                        </div>
                        <div class="resumen-content">
                            <div class="resumen-stats">
                                <div class="resumen-stat-box dias">
                                    <div class="resumen-stat-label">D√≠as</div>
                                    <div class="resumen-stat-value">${diasNormales}</div>
                                </div>
                                <div class="resumen-stat-box extras">
                                    <div class="resumen-stat-label">Extras</div>
                                    <div class="resumen-stat-value">${extras}</div>
                                </div>
                                <div class="resumen-stat-box total">
                                    <div class="resumen-stat-label">Total</div>
                                    <div class="resumen-stat-value">${total}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
            document.getElementById('totalEmpleados').textContent = empleadosFiltrados.length;
        }

        function toggleResumen(empId) {
            const item = document.getElementById(`resumen-${empId}`);
            item.classList.toggle('expanded');
        }

        function exportarExcel() {
            if (empleados.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            let csv = 'Nombre,D√≠as Normales,Extras,Total\n';

            empleados.forEach(emp => {
                let diasNormales, extras, total;
                
                if (quincenaActual === 1) {
                    // 1ra quincena: solo d√≠as normales, SIN extras
                    const totales = calcularTotales(emp.id, false);
                    diasNormales = totales.diasNormales;
                    extras = 0; // No se pagan extras en 1ra quincena
                    total = diasNormales;
                } else {
                    // 2da quincena: d√≠as normales + TODOS los extras del mes
                    const totales = calcularTotales(emp.id, true);
                    diasNormales = totales.diasNormales;
                    extras = totales.extras; // Incluye extras de ambas quincenas
                    total = diasNormales + extras;
                }
                
                csv += `"${emp.nombre}",${diasNormales},${extras},${total}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const hoy = new Date();
            const nombreArchivo = `asistencias_quincena${quincenaActual}_${hoy.getDate()}-${hoy.getMonth()+1}-${hoy.getFullYear()}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', nombreArchivo);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function limpiarMesAnterior() {
            if (!confirm('‚ö†Ô∏è ATENCI√ìN: Esto eliminar√° TODOS los registros de asistencias del mes anterior.\n\n¬øEst√°s seguro de continuar?\n\nAseg√∫rate de haber exportado los datos antes de limpiar.')) {
                return;
            }

            if (!confirm('Segunda confirmaci√≥n: ¬øRealmente deseas eliminar todos los registros? Esta acci√≥n NO se puede deshacer.')) {
                return;
            }

            // Limpiar todas las asistencias
            asistencias = {};
            guardarDatos();
            
            // Actualizar vistas
            renderAsistencias();
            renderResumen();
            
            alert('‚úÖ Registros del mes anterior eliminados correctamente.');
        }

        function moverDiasAlSiguienteMes() {
            const hoy = new Date();
            const mes = hoy.getMonth();
            const anio = hoy.getFullYear();
            const ultimoDiaMes = new Date(anio, mes + 1, 0).getDate();

            // Pedir al usuario desde qu√© d√≠a quiere mover
            const desdeDia = prompt(`¬øDesde qu√© d√≠a quieres mover al siguiente mes?\n\nPor ejemplo:\n- Si cierras el 27, ingresa 28\n- Si cierras el 28, ingresa 29\n- Si cierras el 30, ingresa 31\n\nIngresa el n√∫mero (entre 16 y ${ultimoDiaMes}):`);
            
            if (!desdeDia) return; // Cancel√≥
            
            const diaInicio = parseInt(desdeDia);
            
            if (isNaN(diaInicio) || diaInicio < 16 || diaInicio > ultimoDiaMes) {
                alert(`‚ö†Ô∏è D√≠a inv√°lido. Debe ser entre 16 y ${ultimoDiaMes}`);
                return;
            }

            // Confirmar acci√≥n
            const diasAMover = ultimoDiaMes - diaInicio + 1;
            if (!confirm(`Vas a mover ${diasAMover} d√≠a(s) (del ${diaInicio} al ${ultimoDiaMes}) al inicio del siguiente mes.\n\n¬øContinuar?`)) {
                return;
            }

            let registrosMovidos = 0;
            
            // Para cada empleado
            empleados.forEach(emp => {
                let diaDestino = 1; // Empezar en el d√≠a 1 del siguiente mes
                
                // Mover cada d√≠a desde diaInicio hasta el √∫ltimo d√≠a del mes
                for (let diaOrigen = diaInicio; diaOrigen <= ultimoDiaMes; diaOrigen++) {
                    const keyOrigen = `${emp.id}-2-${diaOrigen}`; // Siempre de la 2da quincena
                    const keyDestino = `${emp.id}-1-${diaDestino}`; // A la 1ra quincena del siguiente mes
                    
                    if (asistencias[keyOrigen]) {
                        // Copiar registro al d√≠a destino
                        asistencias[keyDestino] = asistencias[keyOrigen];
                        // Borrar registro origen
                        delete asistencias[keyOrigen];
                        registrosMovidos++;
                    }
                    
                    diaDestino++;
                }
            });

            guardarDatos();
            renderAsistencias();
            renderResumen();
            
            alert(`‚úÖ Se movieron ${registrosMovidos} registros al siguiente mes.\n\nAhora puedes limpiar el mes anterior cuando est√©s listo.`);
        }

        // Esperar a que Firebase est√© cargado antes de inicializar
        window.addEventListener('load', () => {
            // Dar un peque√±o delay para asegurar que Firebase est√© completamente cargado
            setTimeout(() => {
                init();
            }, 500);
        });
    </script>
</body>
</html>
